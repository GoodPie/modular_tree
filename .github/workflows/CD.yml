name: Build and Release
on: [push]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/ruff-action@v1
      - uses: astral-sh/ruff-action@v1
        with:
          args: "format --check"

  test:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Bootstrap vcpkg
        run: |
          cd m_tree/dependencies/vcpkg
          ./bootstrap-vcpkg.sh
          ./vcpkg install eigen3:x64-linux

      - name: Configure and Build
        run: |
          mkdir -p m_tree/build
          cd m_tree/build
          cmake ../ -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release

      - name: Run Tests
        run: |
          cd m_tree/build
          ctest --output-on-failure -C Release

  build-wheels:
    needs: test
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: pypa/cibuildwheel@v2.21
        with:
          package-dir: m_tree
        env:
          CIBW_BUILD: cp311-manylinux_x86_64 cp311-macosx_arm64 cp311-win_amd64
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
          CIBW_BEFORE_BUILD_LINUX: >
            dnf install -y zip unzip tar curl &&
            cd {package}/dependencies/vcpkg &&
            ./bootstrap-vcpkg.sh &&
            ./vcpkg install eigen3:x64-linux
          CIBW_BEFORE_BUILD_MACOS: >
            cd {package}/dependencies/vcpkg &&
            ./bootstrap-vcpkg.sh &&
            ./vcpkg install eigen3:arm64-osx
          CIBW_BEFORE_BUILD_WINDOWS: >
            cd /d {package}\dependencies\vcpkg &&
            bootstrap-vcpkg.bat &&
            vcpkg install eigen3:x64-windows
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl

  test-python:
    needs: build-wheels
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - uses: actions/download-artifact@v4
        with:
          name: wheels-ubuntu-latest
          path: wheels
      - name: Install wheel and test dependencies
        run: |
          uv pip install wheels/*.whl
          uv pip install pytest
      - name: Run Python tests
        run: uv run pytest tests/unit -v

  package-addon:
    needs: [build-wheels, test-python]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: actions/download-artifact@v4
        with:
          path: wheels
          merge-multiple: true
      - name: Display downloaded wheels
        run: ls -R wheels
      - name: Package addon
        run: python .github/scripts/setup_addon.py
      - uses: actions/upload-artifact@v4
        with:
          name: modular_tree_extension
          path: tmp/*.zip

  release:
    needs: package-addon
    runs-on: ubuntu-latest
    env:
      STATUS: ${{ !endsWith(github.ref, 'master') && 'alpha' || '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: modular_tree_extension
          path: release
      - name: Display structure of downloaded files
        run: ls -R release
      - name: Get version
        id: vars
        run: |
          RAW_VERSION=$(cat VERSION)
          echo "raw_version=$RAW_VERSION" >> $GITHUB_OUTPUT
          echo "version=$(echo $RAW_VERSION | tr '_' '.')" >> $GITHUB_OUTPUT
      - name: Update release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: release/*.zip
          name: Release V${{ steps.vars.outputs.version }}${{ env.STATUS }}
          tag_name: ${{ steps.vars.outputs.version }}${{ env.STATUS }}
          body: V${{ steps.vars.outputs.version }}
