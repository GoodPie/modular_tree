name: Build and Release
on: [push]

jobs:
  build-wheels:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: pypa/cibuildwheel@v2.21
        with:
          package-dir: m_tree
        env:
          CIBW_BUILD: cp311-*
          CIBW_ARCHS_MACOS: arm64
          CIBW_ARCHS_LINUX: x86_64
          CIBW_ARCHS_WINDOWS: AMD64
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl

  package-addon:
    needs: build-wheels
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: actions/download-artifact@v4
        with:
          path: wheels
          merge-multiple: true
      - name: Display downloaded wheels
        run: ls -R wheels
      - name: Package addon
        run: python .github/scripts/setup_addon.py
      - uses: actions/upload-artifact@v4
        with:
          name: modular_tree_extension
          path: tmp/*.zip

  release:
    needs: package-addon
    runs-on: ubuntu-latest
    env:
      STATUS: ${{ !endsWith(github.ref, 'master') && 'alpha' || '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: modular_tree_extension
          path: release
      - name: Display structure of downloaded files
        run: ls -R release
      - name: Get version
        id: vars
        run: |
          RAW_VERSION=$(cat VERSION)
          echo "raw_version=$RAW_VERSION" >> $GITHUB_OUTPUT
          echo "version=$(echo $RAW_VERSION | tr '_' '.')" >> $GITHUB_OUTPUT
      - name: Update release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: release/*.zip
          name: Release V${{ steps.vars.outputs.version }}${{ env.STATUS }}
          tag_name: ${{ steps.vars.outputs.version }}${{ env.STATUS }}
          body: V${{ steps.vars.outputs.version }}
